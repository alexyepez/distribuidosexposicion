<!DOCTYPE html>
<html>
<head>
    <title>Chat Seguro</title>
    <style>
        #chat, #metrics { margin: 20px; font-family: Arial; }
        #chat { height: 200px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; }
        #metrics { white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Chat Seguro con TLS</h1>
    <div id="chat"></div>
    <input id="message" type="text" placeholder="Escribe un mensaje">
    <button onclick="sendMessage()">Enviar</button>
    <h2>Métricas de Seguridad</h2>
    <div id="metrics"></div>
    <button onclick="updateMetrics()">Refrescar Métricas</button>

    <script>
        const ws = new WebSocket("wss://127.0.0.1:8766");
        const chatDiv = document.getElementById("chat");
        const messageInput = document.getElementById("message");
        const metricsDiv = document.getElementById("metrics");

        ws.onmessage = (event) => {
            console.log("Mensaje recibido:", event.data);
            chatDiv.innerText += event.data + "\n";
            chatDiv.scrollTop = chatDiv.scrollHeight;
        };

        ws.onerror = (error) => {
            console.log("Error en WebSocket:", error);
            chatDiv.innerText += "Error de conexión al WebSocket.\n";
        };

        ws.onopen = () => {
            chatDiv.innerText += "Conexión establecida con éxito.\n";
        };

        function sendMessage() {
            const message = messageInput.value;
            if (message && ws.readyState === WebSocket.OPEN) {
                ws.send(message);
                messageInput.value = "";
            } else {
                chatDiv.innerText += "Error: No se pudo enviar el mensaje.\n";
            }
        }

        function updateMetrics() {
            fetch("https://127.0.0.1:8443/security_status", {
                cache: "no-store",
                credentials: "omit"
            })
            .then(response => {
                console.log("Estado de la respuesta:", response.status); // Depuración
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text(); // Primero como texto
            })
            .then(text => {
                console.log("Respuesta cruda completa:", text); // Mostrar todo
                if (!text) throw new Error("Respuesta vacía");
                try {
                    const data = JSON.parse(text);
                    console.log("Métricas recibidas:", data);
                    metricsDiv.innerText = JSON.stringify(data, null, 2);
                } catch (e) {
                    console.error("Error al parsear JSON:", e);
                    metricsDiv.innerText = `Error parseando respuesta: ${text}`;
                }
            })
            .catch(error => {
                console.error("Error detallado:", error);
                metricsDiv.innerText = `Error al obtener métricas: ${error.message}`;
            });
        }

        setInterval(updateMetrics, 2000);
        updateMetrics();
    </script>
</body>
</html>